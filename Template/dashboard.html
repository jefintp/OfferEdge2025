{% extends 'base_logged_in.html' %}
{% load custom_tags %}
{% load custom_filters %}
{% block title %}Welcome | OfferEdge{% endblock %}

{% block content %}
<main class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-blue-100 py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-5xl mx-auto bg-white/80 backdrop-blur-sm shadow-2xl rounded-2xl p-6 sm:p-10 border border-gray-100">

    {% if finalized_success %}
      <div class="bg-gradient-to-r from-green-100 to-green-50 border border-green-300 text-green-800 px-6 py-4 rounded-lg relative mb-8 text-center text-lg font-semibold shadow-sm animate-fade-in">
        <span class="mr-2">🎉</span> Deal finalized successfully!
      </div>
    {% endif %}




    <!-- Requirements Section -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2 flex items-center justify-between">
        <span class="flex items-center"><span class="mr-3 text-blue-500 text-2xl">📝</span> Your Posted Requirements</span>
        <a href="{% url 'post_requirement' %}" class="text-sm text-blue-700 hover:underline">Post new</a>
      </h2>

      {% if requirements %}
        <div class="relative">
<button id="requirements-carousel-prev" class="flex items-center justify-center absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-slate-800 w-9 h-9 rounded-full shadow border border-slate-200 z-20">‹</button>
          <div id="requirements-carousel-count" class="absolute right-12 top-2 text-xs text-slate-700 bg-white/80 border border-slate-200 px-2 py-0.5 rounded-full">1/—</div>
          <div id="requirements-carousel-track" class="flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory px-1 py-1 no-scrollbar">
            {% for req in requirements %}
            <div class="req-card min-w-[85%] sm:min-w-[60%] md:min-w-[50%] snap-start">
            <div class="bg-white border border-gray-200 rounded-xl shadow-md p-6 transition-all duration-200 relative cursor-pointer hover:bg-blue-50 hover:border-blue-200 hover:shadow-lg active:bg-blue-100 active:border-blue-300" onclick="window.location.href='{% url 'requirement_detail' req.id %}'">
              {% if req.selected_quote_finalized %}
              <span class="absolute top-3 right-3 inline-flex items-center bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-medium">Finalized</span>
              {% else %}
              <span class="absolute top-3 right-3 inline-flex items-center bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs font-medium">In Progress</span>
              {% endif %}
              <h3 class="text-xl font-bold text-blue-700 mb-2">
                <a href="{% url 'requirement_detail' req.id %}" class="hover:underline">{{ req.title }}</a>
              </h3>
                <p class="text-sm text-gray-600 mb-3">{{ req.description|truncatechars:100 }}</p>
                <div class="text-sm text-gray-600 space-y-1 mb-4">
                  <p><span class="font-semibold">📦 Quantity:</span> {{ req.quantity }}</p>
                  <p><span class="font-semibold">💰 Price Range:</span> {{ req.expectedPriceRange }}</p>
                  <p><span class="font-semibold">⏰ Deadline:</span> {{ req.deadline }}</p>
                  <p class="text-xs text-gray-400">Posted: {{ req.createdAt|date:"M d, Y" }}</p>
                </div>
                <div class="flex justify-between items-center text-sm">
                  <p class="text-blue-600 font-semibold">Quotes: {{ req.quotes|length }}</p>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
<button id="requirements-carousel-next" class="flex items-center justify-center absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-slate-800 w-9 h-9 rounded-full shadow border border-slate-200 z-20">›</button>
        </div>
      {% else %}
        <p class="text-gray-600 text-center py-4 border border-gray-200 rounded-lg bg-white/60">You haven’t posted any requirements yet. Get started by posting one!</p>
      {% endif %}
    </section>

    <!-- Quotes Section -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-4 border-green-500 pb-2 flex items-center">
        <span class="mr-3 text-green-500 text-2xl">✍️</span> Your Placed Quotes
      </h2>

      {% if quote_data %}
        <div class="relative">
<button id="quotes-carousel-prev" class="hidden sm:flex items-center justify-center absolute left-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-slate-800 w-9 h-9 rounded-full shadow border border-slate-200 z-20">‹</button>
<div id="quotes-carousel-track" class="flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory px-1 py-1 no-scrollbar">
            {% for item in quote_data %}
              {% with quote=item.quote req_id=item.requirement_id req_title=item.requirement_title status=item.status buyer=item.requirement_buyerid expected=item.requirement_expected_price %}
              <div class="min-w-[320px] max-w-[360px] snap-start">
                <div class="quote-card border rounded-xl shadow-md p-6 transition-all duration-200 relative {% if status == 'selected' %} bg-green-50 border-green-300 {% elif status == 'rejected' %} bg-red-50 border-red-300 {% else %} bg-yellow-50 border-yellow-300 {% endif %} {% if req_id %}cursor-pointer hover:shadow-lg{% endif %}"
                  {% if req_id %}onclick="window.location.href='{% url 'quotes_for_requirement' req_id %}'"{% endif %}>

                  {% if status != 'selected' %}
                  <form method="POST" action="{% url 'delete_quote' quote.id %}" onsubmit="return confirm('Delete this quote?');" onclick="event.stopPropagation();" class="absolute top-2 right-2">
                    {% csrf_token %}
                    <button type="submit" class="w-7 h-7 inline-flex items-center justify-center rounded-full text-red-600 hover:text-red-700 hover:bg-red-50" aria-label="Delete quote" title="Delete">
                      ×
                    </button>
                  </form>
                  {% endif %}

                  <h3 class="text-xl font-bold text-green-700 mb-1">Your Quote</h3>
                  <div class="mb-3 p-3 rounded-lg bg-blue-50 border border-blue-100">
                    <p class="text-sm text-slate-800">📄 Requirement: <span class="font-medium">{{ req_title }}</span></p>
                  <p class="text-sm text-slate-800">👤 Buyer: <span class="font-medium">{{ buyer|default:"—" }}</span></p>
                  {% if expected %}
                  <p class="text-sm text-slate-800">💰 Expected: <span class="font-medium">{{ expected }}</span></p>
                  {% endif %}
                  </div>

                  <div class="text-sm text-gray-600 space-y-1 mb-4">
                    <p><span class="font-semibold">💰 Your Price:</span> ₹{{ quote.price }}</p>
                    <p><span class="font-semibold">📦 Delivery:</span> {{ quote.deliveryTimeline }}</p>
                    <p class="text-xs text-gray-500">Notes: {{ quote.notes|truncatechars:50 }}</p>
                    <p class="text-xs text-gray-400">Placed: {{ quote.createdon|date:"M d, Y" }}</p>
                  </div>

                {% if status != 'selected' and chat_enabled_map|get_item:quote.id %}
                  <a href="{% url 'start_chat' quote.id %}"
                     class="inline-flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium hover:bg-green-200 transition"
                     onclick="event.stopPropagation();">
                    <span class="mr-1">💬</span> Start Negotiation
                  </a>
                {% endif %}

                  {% if status == 'selected' %}
                    <span class="inline-flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium mt-2 ml-2">
                      <span class="mr-1">✅</span> Accepted
                    </span>
                  {% elif status == 'rejected' %}
                    <span class="inline-flex items-center bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm font-medium mt-2 ml-2">
                      <span class="mr-1">❌</span> Rejected
                    </span>
                  {% else %}
                    <span class="inline-flex items-center bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-medium mt-2 ml-2">
                      <span class="mr-1">🟡</span> In Progress
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endwith %}
            {% endfor %}
          </div>
<button id="quotes-carousel-next" class="hidden sm:flex items-center justify-center absolute right-0 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-slate-800 w-9 h-9 rounded-full shadow border border-slate-200 z-20">›</button>
        </div>

            {% else %}
        <p class="text-gray-600 text-center py-4 border border-gray-200 rounded-lg bg-white/60">
          You haven’t placed any quotes yet. Explore requirements and make an offer!
        </p>
      {% endif %}
    </section>

    <div class="text-center mt-12 pt-6 border-t border-gray-200">
      <p class="text-md text-gray-500">
        Need help? <a href="#" class="text-blue-600 hover:underline font-medium">Contact Support</a>
      </p>
    </div>
  </div>
</main>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
  }
  /* Hide scrollbar for carousels */
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
<script>
  (function(){
    function initCarousel(trackId, prevId, nextId, step, cardSelector, countSelector){
      const track = document.getElementById(trackId);
      const prev = document.getElementById(prevId);
      const next = document.getElementById(nextId);
      const countEl = countSelector ? document.getElementById(countSelector) : null;
      if (!track || !prev || !next) return;
      let scrollStep = step;
      let total = 0;
      if (cardSelector) {
        const cards = track.querySelectorAll(cardSelector);
        total = cards.length;
        if (cards[0]) {
          const cardRect = cards[0].getBoundingClientRect();
          scrollStep = Math.round(cardRect.width + 16);
        }
      }
      function updateCount(){
        if (!countEl || total === 0) return;
        const idx = Math.max(0, Math.round(track.scrollLeft / scrollStep));
        countEl.textContent = `${Math.min(idx + 1, total)}/${total}`;
      }
      prev.classList.remove('hidden');
      next.classList.remove('hidden');
      prev.addEventListener('click', function(){ track.scrollBy({left: -scrollStep, behavior: 'smooth'}); setTimeout(updateCount, 200); });
      next.addEventListener('click', function(){ track.scrollBy({left: scrollStep, behavior: 'smooth'}); setTimeout(updateCount, 200); });
      track.addEventListener('scroll', updateCount);
      updateCount();
    }
    const STEP = 360;
    initCarousel('quotes-carousel-track','quotes-carousel-prev','quotes-carousel-next', STEP);
    initCarousel('requirements-carousel-track','requirements-carousel-prev','requirements-carousel-next', STEP, '.req-card', 'requirements-carousel-count');
  })();
</script>
{% endblock %}
