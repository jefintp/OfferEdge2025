{% extends 'base_logged_in.html' %}
{% block title %}Moderation Panel | OfferEdge{% endblock %}
{% block content %}

<main class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/40 to-indigo-50 py-10 px-6">

  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-10 flex items-center gap-2">
      🛡️ <span class="bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent">Moderation Panel</span>
    </h1>

    <!-- 🔹 USER MANAGEMENT -->
    <section class="mb-12 bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
          👥 All Users
        </h2>
        <div class="flex items-center gap-3 w-full md:w-auto">
          <form method="GET" action="{% url 'moderation_dashboard' %}" class="flex-1 md:flex-initial flex items-center gap-2">
            <input type="text" name="q" value="{{ q|default:'' }}" placeholder="Search by user id" class="w-full md:w-64 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Search</button>
          </form>
          {% if q %}
            <a href="{% url 'moderation_dashboard' %}" class="text-sm text-gray-600 hover:underline">Clear</a>
          {% endif %}
          <span class="text-sm text-gray-500">{{ users|length }} users total</span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-blue-50 text-blue-800 font-semibold uppercase text-xs tracking-wide">
              <th class="px-4 py-3 text-left">User ID</th>
              <th class="px-4 py-3 text-left">Buyer</th>
              <th class="px-4 py-3 text-left">Seller</th>
              <th class="px-4 py-3 text-left">Admin</th>
              <th class="px-4 py-3 text-left">Banned</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% if q %}
              {% for user in users %}
              <tr class="hover:bg-gray-50 transition-colors duration-150">
                <td class="px-4 py-3 font-medium text-gray-700">{{ user.userid }}</td>
                <td class="px-4 py-3">{% if user.is_buyer %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
                <td class="px-4 py-3">{% if user.is_seller %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
                <td class="px-4 py-3">{% if user.is_admin %}🛡️{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
                <td class="px-4 py-3 text-red-500 font-semibold">{% if user.is_banned %}🚫{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3 space-y-1">
                {% if user.is_admin or user.userid == 'admin' %}
                  <span class="text-gray-400">Admin (actions disabled)</span>
                {% else %}
                  {% if user.is_banned %}
                  <form method="POST" action="{% url 'unban_user' user.userid %}">
                    {% csrf_token %}
                    <button class="text-green-600 hover:text-green-700 font-medium">Unban</button>
                  </form>
                  {% else %}
                  <form method="POST" action="{% url 'ban_user' user.userid %}">
                    {% csrf_token %}
                    <button class="text-red-600 hover:text-red-700 font-medium">Ban</button>
                  </form>
                  {% endif %}
                  <form method="POST" action="{% url 'delete_user' user.userid %}">
                    {% csrf_token %}
                    <button class="text-gray-600 hover:text-gray-800 font-medium">Delete</button>
                  </form>
                {% endif %}
              </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="px-4 py-6 text-center text-gray-500">No users found.</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="px-4 py-6 text-center text-gray-500">Search by user id to view results.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 REQUIREMENT MODERATION -->
    <section class="mb-12 bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        📦 All Requirements
      </h2>
      {% if requirements %}
      <ul class="space-y-5">
        {% for req in requirements %}
        <li class="p-5 rounded-xl border-l-4 shadow-sm transition-transform hover:scale-[1.01] 
          {% if req.flagged %}border-red-500 bg-red-50/60{% else %}border-blue-500 bg-blue-50/40{% endif %}">
          <h3 class="text-lg font-semibold text-blue-700">{{ req.title }}</h3>
          <p class="text-sm text-gray-700 mt-1">{{ req.description }}</p>
          <p class="text-xs text-gray-500 mt-1">Posted by <span class="font-medium text-gray-700">{{ req.buyerid }}</span> — {{ req.createdAt }}</p>
          
          {% if req.flagged %}
          <p class="text-xs text-red-600 font-semibold mt-2">🚩 Flagged Reason: {{ req.flag_reason }}</p>
          {% endif %}
          
          <div class="mt-4 flex flex-wrap gap-4">
            <form method="POST" action="{% url 'mod_delete_requirement' req.id %}" onsubmit="return confirm('Delete this requirement and related quotes/deals?');">
              {% csrf_token %}
              <button class="inline-flex items-center gap-1 text-red-600 font-semibold hover:underline">
                🗑️ Delete
              </button>
            </form>
            {% if req.flagged %}
            <form method="POST" action="/moderator/approve_requirement/{{ req.id }}">
              {% csrf_token %}
              <button class="inline-flex items-center gap-1 text-green-600 font-semibold hover:underline">
                ✅ Approve
              </button>
            </form>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500 text-center py-6">No requirements to review.</p>
      {% endif %}
    </section>

    <!-- 🔹 QUOTES MODERATION -->
    <section class="bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6 mb-12">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        💬 Placed Quotes
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-blue-50 text-blue-800 font-semibold uppercase text-xs tracking-wide">
              <th class="px-4 py-3 text-left">Quote ID</th>
              <th class="px-4 py-3 text-left">Requirement</th>
              <th class="px-4 py-3 text-left">Seller</th>
              <th class="px-4 py-3 text-left">Price</th>
              <th class="px-4 py-3 text-left">Finalized</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for quote in quote_rows %}
            <tr class="hover:bg-gray-50 transition-colors duration-150 {% if quote.finalized %}bg-green-50{% endif %}">
              <td class="px-4 py-3 font-medium text-gray-700">{{ quote.id }}</td>
              <td class="px-4 py-3">{{ quote.req_title|default:"(untitled)" }}</td>
              <td class="px-4 py-3">{{ quote.seller_id }}</td>
              <td class="px-4 py-3 text-gray-700 font-semibold">₹{{ quote.price }}</td>
              <td class="px-4 py-3">{% if quote.finalized %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3 space-x-3">
                {% if not quote.finalized %}
                <form method="POST" action="{% url 'mod_finalize_quote' quote.id %}" class="inline" onsubmit="return confirm('Finalize this quote?');">
                  {% csrf_token %}
                  <button class="text-green-600 hover:text-green-700 font-medium">Finalize</button>
                </form>
                {% endif %}
                <form method="POST" action="{% url 'mod_delete_quote' quote.id %}" class="inline" onsubmit="return confirm('Delete this quote?');">
                  {% csrf_token %}
                  <button class="text-red-600 hover:text-red-700 font-medium">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 REPORTS -->
    <section class="bg-white/90 backdrop-blur-sm shadow-lg border border-red-100 rounded-2xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        🚩 User Reports
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-red-50 text-red-800 font-semibold uppercase text-xs tracking-wide">
              <th class="px-4 py-3 text-left">Created</th>
              <th class="px-4 py-3 text-left">Reporter</th>
              <th class="px-4 py-3 text-left">Reported</th>
              <th class="px-4 py-3 text-left">Requirement</th>
              <th class="px-4 py-3 text-left">Status</th>
              <th class="px-4 py-3 text-left">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for r in report_rows %}
            <tr class="hover:bg-gray-50 transition-colors duration-150">
              <td class="px-4 py-3 text-gray-700">{{ r.created_at|date:"M d, Y H:i" }}</td>
              <td class="px-4 py-3 font-medium">{{ r.reporter_id }}</td>
              <td class="px-4 py-3">{{ r.reported_id }}</td>
              <td class="px-4 py-3">{{ r.requirement_title }}</td>
              <td class="px-4 py-3">{{ r.status|capfirst }}</td>
              <td class="px-4 py-3">
                <a href="{% url 'report_detail' r.id %}" class="text-red-700 hover:underline font-medium">View</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="px-4 py-6 text-center text-gray-500">No reports yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
</main>

{% endblock %}
