{% extends 'base_logged_in.html' %}
{% block title %}Moderation Panel | OfferEdge{% endblock %}
{% block content %}

<main class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50/40 to-indigo-50 py-10 px-6">

  <div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-10 flex items-center gap-2">
      🛡️ <span class="bg-gradient-to-r from-blue-600 to-indigo-700 bg-clip-text text-transparent">Moderation Panel</span>
    </h1>

    <!-- 🔹 USER MANAGEMENT -->
    <section class="mb-12 bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
          👥 All Users
        </h2>
        <span class="text-sm text-gray-500">{{ users|length }} users total</span>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-blue-50 text-blue-800 font-semibold uppercase text-xs tracking-wide">
              <th class="px-4 py-3 text-left">User ID</th>
              <th class="px-4 py-3 text-left">Buyer</th>
              <th class="px-4 py-3 text-left">Seller</th>
              <th class="px-4 py-3 text-left">Admin</th>
              <th class="px-4 py-3 text-left">Banned</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for user in users %}
            <tr class="hover:bg-gray-50 transition-colors duration-150">
              <td class="px-4 py-3 font-medium text-gray-700">{{ user.userid }}</td>
              <td class="px-4 py-3">{% if user.is_buyer %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3">{% if user.is_seller %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3">{% if user.is_admin %}🛡️{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3 text-red-500 font-semibold">{% if user.is_banned %}🚫{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3 space-y-1">
                {% if user.is_banned %}
                <form method="POST" action="/moderator/unban_user/{{ user.id }}">
                  {% csrf_token %}
                  <button class="text-green-600 hover:text-green-700 font-medium">Unban</button>
                </form>
                {% else %}
                <form method="POST" action="/moderator/ban_user/{{ user.id }}">
                  {% csrf_token %}
                  <button class="text-red-600 hover:text-red-700 font-medium">Ban</button>
                </form>
                {% endif %}
                <form method="POST" action="/moderator/delete_user/{{ user.id }}">
                  {% csrf_token %}
                  <button class="text-gray-600 hover:text-gray-800 font-medium">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 REQUIREMENT MODERATION -->
    <section class="mb-12 bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        📦 All Requirements
      </h2>
      {% if requirements %}
      <ul class="space-y-5">
        {% for req in requirements %}
        <li class="p-5 rounded-xl border-l-4 shadow-sm transition-transform hover:scale-[1.01] 
          {% if req.flagged %}border-red-500 bg-red-50/60{% else %}border-blue-500 bg-blue-50/40{% endif %}">
          <h3 class="text-lg font-semibold text-blue-700">{{ req.title }}</h3>
          <p class="text-sm text-gray-700 mt-1">{{ req.description }}</p>
          <p class="text-xs text-gray-500 mt-1">Posted by <span class="font-medium text-gray-700">{{ req.buyerid }}</span> — {{ req.createdAt }}</p>
          
          {% if req.flagged %}
          <p class="text-xs text-red-600 font-semibold mt-2">🚩 Flagged Reason: {{ req.flag_reason }}</p>
          {% endif %}
          
          <div class="mt-4 flex flex-wrap gap-4">
            <form method="POST" action="/requirements/delete/{{ req.id }}" onsubmit="return confirm('Delete this requirement?');">
              {% csrf_token %}
              <button class="inline-flex items-center gap-1 text-red-600 font-semibold hover:underline">
                🗑️ Delete
              </button>
            </form>
            {% if req.flagged %}
            <form method="POST" action="/moderator/approve_requirement/{{ req.id }}">
              {% csrf_token %}
              <button class="inline-flex items-center gap-1 text-green-600 font-semibold hover:underline">
                ✅ Approve
              </button>
            </form>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500 text-center py-6">No requirements to review.</p>
      {% endif %}
    </section>

    <!-- 🔹 QUOTES MODERATION -->
    <section class="bg-white/90 backdrop-blur-sm shadow-lg border border-blue-100 rounded-2xl p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        💬 Placed Quotes
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm">
          <thead>
            <tr class="bg-blue-50 text-blue-800 font-semibold uppercase text-xs tracking-wide">
              <th class="px-4 py-3 text-left">Quote ID</th>
              <th class="px-4 py-3 text-left">Requirement</th>
              <th class="px-4 py-3 text-left">Seller</th>
              <th class="px-4 py-3 text-left">Price</th>
              <th class="px-4 py-3 text-left">Finalized</th>
              <th class="px-4 py-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for quote in quotes %}
            <tr class="hover:bg-gray-50 transition-colors duration-150 {% if quote.finalized %}bg-green-50{% endif %}">
              <td class="px-4 py-3 font-medium text-gray-700">{{ quote.id }}</td>
              <td class="px-4 py-3">{{ quote.req_title|default:"(untitled)" }}</td>
              <td class="px-4 py-3">{{ quote.seller_id }}</td>
              <td class="px-4 py-3 text-gray-700 font-semibold">₹{{ quote.price }}</td>
              <td class="px-4 py-3">{% if quote.finalized %}✅{% else %}<span class="text-gray-400">—</span>{% endif %}</td>
              <td class="px-4 py-3 space-x-3">
                {% if not quote.finalized %}
                <form method="POST" action="/moderator/finalize_quote/{{ quote.id }}" class="inline">
                  {% csrf_token %}
                  <button class="text-green-600 hover:text-green-700 font-medium">Finalize</button>
                </form>
                {% endif %}
                <form method="POST" action="/moderator/delete_quote/{{ quote.id }}" class="inline">
                  {% csrf_token %}
                  <button class="text-red-600 hover:text-red-700 font-medium">Delete</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
</main>

{% endblock %}
