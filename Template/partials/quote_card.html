{% load custom_filters %}
{% with quote_id_str=quote.id|stringformat:"s" %}
{% with status=quote_status_map|get_item:quote_id_str %}
<div class="border-t pt-4 mt-4 rounded-lg p-4
  {% if status == 'selected' %}
    border-green-500 bg-green-50
  {% elif status == 'rejected' %}
    border-red-400 bg-red-50
  {% else %}
    border-gray-200 bg-white
  {% endif %}
">

  <!-- 🏷️ Quote Header -->
  <h4 class="font-semibold text-md mb-2
    {% if status == 'selected' %}
      text-green-700
    {% elif status == 'rejected' %}
      text-red-600
    {% else %}
      text-gray-700
    {% endif %}
  ">
    {% if status == 'selected' %}
      ✅ Selected
    {% elif status == 'rejected' %}
      ❌ Rejected
    {% else %}
      🟡 In Progress
    {% endif %}
  </h4>

  <!-- 💰 Quote Details -->
  <p class="text-sm text-gray-600 mb-1">💰 Price: ₹{{ quote.price }}</p>
  <p class="text-sm text-gray-600 mb-1">🚚 Delivery: {{ quote.deliveryTimeline }}</p>
  <p class="text-xs text-gray-500 mb-3">📝 Notes: {{ quote.notes|default:"—"|truncatechars:50 }}</p>

  <!-- 💬 Start Negotiation -->
  {% if chat_flags|get_item:quote_id_str %}
    <a href="/negotiation/start/{{ quote.id }}/"
       class="inline-flex items-center bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium hover:bg-blue-200 transition">
      <span class="mr-1">💬</span> Start Negotiation
    </a>
  {% endif %}

  <!-- ✅ Finalization Logic -->
  {% if userid == requirement.buyerid %}
    {% if status == 'selected' %}
      <span class="inline-flex items-center bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium mt-2 ml-2">
        <span class="mr-1">✅</span> Finalized
      </span>
    {% elif status == 'in_progress' %}
      <form action="{% url 'finalize_quote' quote.id %}" method="POST" class="inline-block mt-2 ml-2">
        {% csrf_token %}
        <button type="submit"
                class="inline-flex items-center bg-green-600 text-white px-3 py-1 rounded-full text-sm font-medium hover:bg-green-700 transition">
          <span class="mr-1">✅</span> Finalize Deal
        </button>
      </form>
    {% endif %}
  {% endif %}
</div>
{% endwith %}
{% endwith %}